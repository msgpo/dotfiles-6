#!/bin/sh
#
# pbrisbin 2015 - prune branches already merged into master
#
###
set -e

if ! git branch | grep -q '^\* master$'; then
  git checkout --quiet master
fi

echo ":: Updating master"
git pull

echo ":: Rebasing local branches"
git branch | grep -v '^\* master$' | while read -r branch; do
  git checkout --quiet "$branch"
  git rebase master >/dev/null 2>&1 || git rebase --abort
done

git checkout --quiet master

echo ":: Deleting merged branches"
git branch --merged master | grep -v '^\* master$' | while read -r branch; do
  if git branch -d "$branch"; then
    if git branch -r | grep -Fq "origin/$branch"; then
      git push origin ":$branch"
    fi
  fi
done
